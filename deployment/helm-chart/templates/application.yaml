apiVersion: apps/v1
kind: Deployment
metadata:
    name: {{ template "helm-chart.fullname" . }}-deployment
spec:
    replicas: 1
    selector:
        matchLabels:
            app: {{ template "helm-chart.fullname" . }}-pod
    template:
        metadata:
            labels:
                app: {{ template "helm-chart.fullname" . }}-pod
        spec:
            imagePullSecrets:
            -   name: myregistrykey
            containers:
            -   name: {{ .Values.podContainerName }}
                image: {{ .Values.dockerImage }}
                imagePullPolicy: {{ .Values.imagePullPolicy }}
                env:
                -   name: BROKER_SERVICE_URL
                    value: {{ .Values.brokerServiceUrl }}
                -   name: PULSAR_TEXT_EMBEDDING_TOPIC
                    value: {{ .Values.pulsarTextEmbeddingTopic }}
                -   name: SUBSCRIPTION_NAME
                    value: {{ .Values.subscriptionName }}
                -   name: DB_DRIVER
                    value: "{{ .Values.db.driver }}"
                -   name: DB_USER
                    value: "{{ .Values.db.user }}"
                -   name: DB_PASSWORD
                    value: "{{ .Values.db.password }}"
                -   name: DB_HOST
                    value: "{{ .Values.db.host }}"
                -   name: DB_PORT
                    value: "{{ .Values.db.port }}"
                -   name: DB_DATABASENAME
                    value: "{{ .Values.db.databasename }}"


---

apiVersion: v1
kind: Service
metadata:
    name: {{ template "helm-chart.fullname" . }}-service
spec:
    type: NodePort
    selector:
        name: {{ template "helm-chart.fullname" . }}-pod
    ports:
        - port: 80
          targetPort: 1001

---

apiVersion: v1
kind: Secret
metadata:
    name: myregistrykey
type: kubernetes.io/dockerconfigjson
data:
    .dockerconfigjson: {{ template "imagePullSecret" . }}